{% extends "allauth/layouts/base.html" %}
{% block title %}{{course.name}}{% endblock %}
{% block extra_head %}
<style>
/* Star Rating Display Styles */
.star-rating-display {
    display: flex;
    gap: 0.25rem;
    margin: 0.5rem 0;
}

.star-rating-display .star {
    font-size: 1.2rem;
    color: #ddd;
}

.star-rating-display .star.filled {
    color: #ffc107;
}

.rating-item {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.rating-item h3 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    color: #333;
    font-size: 1.1rem;
}

.rating-value {
    font-weight: bold;
    color: #333;
    margin-left: 0.5rem;
}

.percentage-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
    text-align: center;
    margin: 0.5rem 0;
}

/* Accordion Styles */
details {
    margin: 1rem 0;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

details summary {
    padding: 1rem;
    cursor: pointer;
    font-weight: bold;
    background: #f5f5f5;
    border-radius: 8px 8px 0 0;
    transition: background-color 0.2s ease;
}

details summary:hover {
    background: #eeeeee;
}

details[open] summary {
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #e0e0e0;
}

details > div {
    padding: 1rem;
}

/* Individual Rating Review Styles */
.rating-review {
    margin-bottom: 2rem;
    padding: 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.rating-header-with-comment {
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
}

.comment-section {
    margin: 1rem 0;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #007bff;
}

.detailed-feedback {
    margin-top: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #28a745;
}

.detailed-feedback h4 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: #333;
    font-size: 1rem;
}

.feedback-item {
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.feedback-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.feedback-item strong {
    color: #495057;
    display: block;
    margin-bottom: 0.25rem;
}

/* Detailed Feedback Accordion Styles */
.detailed-feedback-accordion {
    margin-top: 0.75rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #f8f9fa;
}

.detailed-feedback-accordion summary {
    padding: 0.75rem;
    cursor: pointer;
    font-weight: bold;
    background: #e9ecef;
    border-radius: 6px 6px 0 0;
    transition: background-color 0.2s ease;
    color: #495057;
}

.detailed-feedback-accordion summary:hover {
    background: #dee2e6;
}

.detailed-feedback-accordion[open] summary {
    border-radius: 6px 6px 0 0;
    border-bottom: 1px solid #e0e0e0;
}

.detailed-feedback-accordion .detailed-feedback {
    margin: 0;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 0 0 6px 6px;
    border-left: none;
}
</style>
{% endblock %}
{% block content %}
<h1>{{ course.name }}</h1>

{% if count %}
  <!-- Overall Rating -->
   <div class="grid">
  <div class="rating-item">
    <h2>Overall Rating</h2>
    <div class="star-rating-display">
      {% for i in "12345" %}
        <span class="star {% if avg >= i|add:0 %}filled{% endif %}">★</span>
      {% endfor %}
    </div>
    <p><span class="rating-value">{{ avg|floatformat:1 }} / 5</span> ({{ count }} ratings)</p>
  </div>

  <!-- Personal Weighted Rating (if user is logged in and has rated) -->
  {% if user.is_authenticated and personal_weighted_rating %}
    <div class="rating-item" style="border-left: 4px solid #007bff;">
      <h2>Your Personal Rating</h2>
      <div class="star-rating-display">
        {% for i in "12345" %}
          <span class="star {% if personal_weighted_rating >= i|add:0 %}filled{% endif %}">★</span>
        {% endfor %}
      </div>
      <p><span class="rating-value">{{ personal_weighted_rating }} / 5</span> (weighted by your preferences)</p>
      <p><small>This rating is calculated using your personal weight preferences for each dimension. <a href="{% url 'edit_profile' %}">Edit your weights</a> to customize this calculation.</small></p>
    </div>
  {% elif user.is_authenticated and user_has_rated %}
    <div class="rating-item" style="border-left: 4px solid #6c757d;">
      <h2>Your Personal Rating</h2>
      <p><small>Personal rating calculation requires setting up your weight preferences. <a href="{% url 'edit_profile' %}">Configure your weights</a> to see your personalized rating.</small></p>
    </div>
  {% endif %}
  </div>

  <!-- Detailed Ratings -->
  <details>
    <summary><h2 style="display: inline;">Detailed Ratings</h2></summary>
    <div class="grid">
    <div class="rating-item">
      <h3>Workload / Time Required</h3>
      {% if rating_averages.avg_workload %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_workload >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_workload|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>

    <div class="rating-item">
      <h3>Perceived Difficulty</h3>
      {% if rating_averages.avg_difficulty %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_difficulty >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_difficulty|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>
    </div>

    <div class="grid">
    <div class="rating-item">
      <h3>Learning Gain</h3>
      {% if rating_averages.avg_learning_gain %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_learning_gain >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_learning_gain|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>

    <div class="rating-item">
      <h3>Teaching Quality</h3>
      {% if rating_averages.avg_teaching_quality %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_teaching_quality >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_teaching_quality|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>
    </div>

    <div class="grid">
    <div class="rating-item">
      <h3>Assessment Fairness</h3>
      {% if rating_averages.avg_assessment_fairness %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_assessment_fairness >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_assessment_fairness|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>

    <div class="rating-item">
      <h3>Practical/Theoretical Balance</h3>
      {% if rating_averages.avg_practical_theoretical %}
        <div class="percentage-display">{{ rating_averages.avg_practical_theoretical|floatformat:0 }}% practical</div>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>
    </div>

    <div class="grid">
    <div class="rating-item">
      <h3>Relevance / Applicability</h3>
      {% if rating_averages.avg_relevance %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_relevance >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_relevance|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>

    <div class="rating-item">
      <h3>Materials & Resources</h3>
      {% if rating_averages.avg_materials %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_materials >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_materials|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>
    </div>

    <div class="grid">
    <div class="rating-item">
      <h3>Support & Responsiveness</h3>
      {% if rating_averages.avg_support %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_support >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_support|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>

    <div class="rating-item">
      <h3>Course Organization</h3>
      {% if rating_averages.avg_organization %}
        <div class="star-rating-display">
          {% for i in "12345" %}
            <span class="star {% if rating_averages.avg_organization >= i|add:0 %}filled{% endif %}">★</span>
          {% endfor %}
        </div>
        <p><span class="rating-value">{{ rating_averages.avg_organization|floatformat:1 }} / 5</span></p>
      {% else %}
        <p>No ratings yet</p>
      {% endif %}
    </div>
  </div>
  </details>

{% else %}
  <p>No ratings yet.</p>
{% endif %}

{% if user.is_authenticated %}
  {% if user_has_rated %}
    <nav>
      <ul>
        <li><a href="{% url 'rate_course' course.slug %}">Edit your rating</a></li>
        <li><a href="{% url 'my_ratings' %}">View all my ratings</a></li>
      </ul>
    </nav>
  {% else %}
    <p><a href="{% url 'rate_course' course.slug %}">Rate this course</a></p>
  {% endif %}
{% else %}
  <p><a href="{% url 'account_login' %}">Log in</a> to rate.</p>
{% endif %}

<hr/>

{% for r in ratings %}
  <div class="rating-review">
    <div class="{% if r.comment %}rating-header-with-comment{% endif %}">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <strong>{{ r.rating }}/5</strong> · {{ r.year }} {{ r.semester }}
          <br><small>Posted {{ r.created_at|date:"Y-m-d" }}</small>
        </div>
        {% if user.is_authenticated and user != r.user %}
          <div>
            {% if r.flags.all %}
              <span class="secondary" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; border-radius: 4px;">
                🏴‍☠️ Reported
              </span>
            {% else %}
              <a href="{% url 'flag_rating' r.id %}" class="secondary" style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">
                🏴‍☠️ Report
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Overall comment - only show if there's a comment -->
    {% if r.comment %}
      <div class="comment-section">
        <strong>Overall Comment:</strong>
        <p>{{ r.comment|linebreaksbr }}</p>
      </div>
    {% endif %}
    
    <!-- Detailed rating texts - only show if there are any detailed texts -->
    {% if r.workload_text or r.difficulty_text or r.learning_gain_text or r.teaching_quality_text or r.assessment_fairness_text or r.practical_theoretical_text or r.relevance_text or r.materials_text or r.support_text or r.organization_text %}
      <details class="detailed-feedback-accordion">
        <summary><strong>Show Detailed Feedback</strong></summary>
        <div class="detailed-feedback">
          {% if r.workload_text %}
            <div class="feedback-item">
              <strong>Workload:</strong> {{ r.workload_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.difficulty_text %}
            <div class="feedback-item">
              <strong>Difficulty:</strong> {{ r.difficulty_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.learning_gain_text %}
            <div class="feedback-item">
              <strong>Learning Gain:</strong> {{ r.learning_gain_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.teaching_quality_text %}
            <div class="feedback-item">
              <strong>Teaching Quality:</strong> {{ r.teaching_quality_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.assessment_fairness_text %}
            <div class="feedback-item">
              <strong>Assessment Fairness:</strong> {{ r.assessment_fairness_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.practical_theoretical_text %}
            <div class="feedback-item">
              <strong>Practical/Theoretical Balance:</strong> {{ r.practical_theoretical_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.relevance_text %}
            <div class="feedback-item">
              <strong>Relevance:</strong> {{ r.relevance_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.materials_text %}
            <div class="feedback-item">
              <strong>Materials & Resources:</strong> {{ r.materials_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.support_text %}
            <div class="feedback-item">
              <strong>Support & Responsiveness:</strong> {{ r.support_text|linebreaksbr }}
            </div>
          {% endif %}
          
          {% if r.organization_text %}
            <div class="feedback-item">
              <strong>Course Organization:</strong> {{ r.organization_text|linebreaksbr }}
            </div>
          {% endif %}
        </div>
      </details>
    {% endif %}
  </div>
  <hr/>
{% empty %}
  <p>No reviews yet.</p>
{% endfor %}
{% endblock %}