{% extends "allauth/layouts/base.html" %}
{% block head_title %}RateMyCourses{% endblock %}
{% block content %}
    <hgroup>
        <h1>Courses</h1>
        <p>Welcome to the TU Berlin course ratings project.</p> 
    </hgroup>
    <hr>
    <p>Here you can check what courses are actually good and what other students think about it. You can log in with your TUB email address to write your own ratings.</p>
    <p>Right now the project focuses on the courses of the Informatik Bachelor program and the Computer Science Master program.</p>
    
    {% if user.is_authenticated %}
    <div class="alert alert-info" style="margin: 1.5rem 0;">
        <h4>Personalized Course Ratings</h4>
        <p>You can now customize how course ratings are weighted for your personal view! <a href="{% url 'edit_profile' %}">Set your preferences</a> to see courses sorted by what matters most to you.</p>
    </div>
    {% endif %}
    
    <div class="alert" style="margin: 1.5rem 0;">
        <h4>Can't find your verification email?</h4>
        <p>If you don't see the verification email in your inbox, it might have been caught by your university's spam filter.</p>
        <p>
            <strong>TU Berlin students:</strong>
            <a href="https://quarantine.tu-berlin.de" target="_blank" rel="noopener">
                Check your TU Berlin quarantine system
            </a>
            to find and release the verification email.
        </p>
    </div>

    <form method="get" action="">
        <fieldset class="grid">
            <div>
                <input type="search"
                name="q"
                placeholder="Search courses…"
                value="{{ q }}"
                aria-label="Search courses"
                />
            </div>
            <div>
                <select name="sort" aria-label="Sort courses">
                <option value="rating" {% if sort == "rating" %}selected{% endif %}>Top rated</option>
                <option value="name" {% if sort == "name" %}selected{% endif %}>Name (A→Z)</option>
                <option value="rating_asc" {% if sort == "rating_asc" %}selected{% endif %}>Lowest rated</option>
                {% if user.is_authenticated %}
                <option value="personal" {% if sort == "personal" %}selected{% endif %}>My Personal Rating</option>
                {% endif %}
                </select>
            </div>
            <div>
                <button type="submit">Search</button>
            </div>
        </fieldset>
        
        <details>
            <summary>Advanced Filters</summary>
            <fieldset class="grid">
                <div>
                    <select name="faculty" aria-label="Filter by faculty">
                        <option value="">All Faculties</option>
                        {% for faculty in faculties %}
                        <option value="{{ faculty }}" {% if faculty_filter == faculty %}selected{% endif %}>{{ faculty }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <select name="fachgebiet" aria-label="Filter by subject area">
                        <option value="">All Subject Areas</option>
                        {% for fachgebiet in fachgebiete %}
                        <option value="{{ fachgebiet }}" {% if fachgebiet_filter == fachgebiet %}selected{% endif %}>{{ fachgebiet }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <select name="professor" aria-label="Filter by professor">
                        <option value="">All Professors</option>
                        {% for professor in professors %}
                        <option value="{{ professor }}" {% if professor_filter == professor %}selected{% endif %}>{{ professor }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <select name="institut" aria-label="Filter by institute">
                        <option value="">All Institutes</option>
                        {% for institut in institute %}
                        <option value="{{ institut }}" {% if institut_filter == institut %}selected{% endif %}>{{ institut }}</option>
                        {% endfor %}
                    </select>
                </div>
            </fieldset>
        </details>
    </form>

    {% if page_obj.paginator.count %}
        <p>
        {% if q %}Results for “{{ q }}”. {% endif %}
        {{ page_obj.paginator.count }} course{{ page_obj.paginator.count|pluralize }}
        </p>
    {% endif %}

    {% if courses %}
        <div class="overflow-auto">
        <table>
        <thead>
            <tr>
            <th style="text-align:left;">Course</th>
            <th style="text-align:left;">Fachgebiet</th>
            <th style="text-align:left;">Professor</th>
            <th style="text-align:center;">Average rating</th>
            <th style="text-align:center;"># Ratings</th>
            </tr>
        </thead>
        <tbody>
            {% for course in courses %}
            <tr>
                <td>
                <a href="{% url 'course_detail' course.slug %}">{{ course.name }}</a>
                </td>
                <td>
                {% if course.fachgebiet %}{{ course.fachgebiet.name }}{% else %}—{% endif %}
                </td>
                <td>
                {% if course.fachgebiet %}{{ course.fachgebiet.professor }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center;">
                {% if course.rating_count %}
                    {{ course.avg_rating|floatformat:1 }} / 5
                {% else %}
                    —
                {% endif %}
                </td>
                <td style="text-align:center;">
                {{ course.rating_count }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
        </div>
    {% else %}
        <p>No courses found.</p>
    {% endif %}

    {% if is_paginated %}
        <nav aria-label="Pagination" style="margin-top:1rem;">
        <ul style="list-style:none; padding:0; display:flex; gap:.5rem;">
            {% if page_obj.has_previous %}
            <li>
                <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if faculty_filter %}&faculty={{ faculty_filter|urlencode }}{% endif %}{% if fachgebiet_filter %}&fachgebiet={{ fachgebiet_filter|urlencode }}{% endif %}{% if professor_filter %}&professor={{ professor_filter|urlencode }}{% endif %}{% if institut_filter %}&institut={{ institut_filter|urlencode }}{% endif %}">« Prev</a>
            </li>
            {% endif %}
            <li>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</li>
            {% if page_obj.has_next %}
            <li>
                <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if faculty_filter %}&faculty={{ faculty_filter|urlencode }}{% endif %}{% if fachgebiet_filter %}&fachgebiet={{ fachgebiet_filter|urlencode }}{% endif %}{% if professor_filter %}&professor={{ professor_filter|urlencode }}{% endif %}{% if institut_filter %}&institut={{ institut_filter|urlencode }}{% endif %}">Next »</a>
            </li>
            {% endif %}
        </ul>
        </nav>
    {% endif %}
{% endblock %}